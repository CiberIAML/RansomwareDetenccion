<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clasificador Ransomware</title>
    <style>
        :root{--bg:#f4f8ff;--text:#0f1724;--muted:#64748b;--primary:#1e6fff;--card:#ffffff}
        html,body{height:100%}
        body {
            font-family: Inter, Arial, sans-serif;
            max-width: none;
            width: 100%;
            margin: 0;
            padding: 24px 36px;
            box-sizing: border-box;
            color:var(--text);
            background: linear-gradient(180deg, #f7fbff 0%, #f4f8ff 100%);
        }

        /* Hero images */
        header{display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:20px;text-align:center;background:linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.8));padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(30,79,255,0.06)}
        header h1{font-size:22px;margin:0;color:var(--primary)}
        header p{margin:0;color:var(--muted);font-size:13px} 
        header div[style]{display:flex;gap:12px;align-items:center}

        .hero {text-align:center}
        .hero-images{display:flex;gap:18px;justify-content:center;align-items:center}
        .hero-placeholder{width:120px;height:88px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(30,111,255,0.08), rgba(30,111,255,0.03));color:var(--primary);font-weight:700;box-shadow:0 1px 6px rgba(14,30,80,0.04)}
        .hero-images figcaption{margin-top:6px;font-size:12px;color:var(--muted)}
        .hero {text-align:center}
        .hero-images{display:flex;gap:10px;justify-content:center;align-items:center}
        .hero-images figure{margin:0;text-align:center}
        .hero-images img{height:110px;width:auto;border-radius:8px;object-fit:cover;filter:grayscale(10%);transition:transform .18s ease}
        .hero-images img:hover{transform:scale(1.04)}
        .hero-images figcaption{margin-top:6px;font-size:12px;color:var(--muted)}

        header{display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:14px;text-align:center}
        header h1{font-size:20px;margin:0}
        header p{margin:0;color:var(--muted);font-size:13px} 

        .container {
            display: flex;
            gap: 18px;
            align-items: flex-start;
        }

        .sidebar-left, .sidebar-right {
            width: 26%;
            min-width: 220px;
        }

        .main {
            width: 48%;
            min-width: 420px;
        }

        .card {
            padding: 16px;
            border: 1px solid #e6e9ef;
            border-radius: 10px;
            margin-bottom: 14px;
            box-sizing: border-box;
            background: #fff;
            box-shadow: 0 1px 4px rgba(20,33,61,0.04);
        }

        label{display:block;font-weight:600;margin-top:6px;font-size:13px}

        input,
        button,
        select,
        textarea {
            padding: 10px;
            width: 100%;
            margin-top: 8px;
            box-sizing: border-box;
            font-size: 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: #fff;
        }

        .muted{color:var(--muted);font-size:13px}

        button {
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            border-radius: 8px;
            padding: 10px 12px;
            font-weight:600;
        }

        button.secondary{background:#f3f4f6;color:#111;border:1px solid #e5e7eb}
        button:disabled{opacity:0.6;cursor:default}

        .row{display:flex;gap:10px}
        .row .col{flex:1}

        pre {
            background: #0f1724;
            color: #e6eef8;
            padding: 14px;
            border-radius:8px;
            font-size:13px;
            max-height:320px;overflow:auto
        }

        img {max-width:100%;border-radius:8px}

        .small{font-size:12px;color:var(--muted)}

        .controls{display:flex;gap:8px;margin-top:8px}

        /* Spinner */
        .spinner{display:inline-block;width:18px;height:18px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin .8s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}

        .badge{display:inline-block;padding:6px 8px;background:#eef2ff;color:var(--primary);border-radius:999px;font-weight:600;font-size:12px}
        .badge.online{background:#ecfdf5;color:#065f46}
        .badge.offline{background:#fff1f2;color:#991b1b}

        @media (max-width: 900px) {
            .container{flex-direction:column}
            .sidebar-left,.sidebar-right,.main{width:100%}
        }

        /* Mejoras responsivas para tablet y m√≥vil */
        @media (max-width: 700px) {
            header{flex-direction:column;align-items:flex-start;gap:8px}
            header div[style]{width:100%;text-align:left}
            #apiInput{width:100%}
            .container{gap:12px}
            .sidebar-left,.sidebar-right{width:100%;min-width:unset}
            .main{width:100%;min-width:unset}
            .controls{flex-direction:column}
            .controls button{width:100%}
            .row{flex-direction:column}
            .small{font-size:13px}
            input, textarea{font-size:16px;padding:12px}
            pre{font-size:13px}
            .badge{font-size:11px;padding:5px 6px}
            img{height:auto;max-height:180px;object-fit:cover}
        }

        @media (max-width: 480px) {
            body{margin:12px auto;padding:0 12px}
            header h1{font-size:18px}
            header p{font-size:12px}
            input,button,textarea{font-size:16px;padding:14px}
            .card{padding:12px}
            pre{font-size:12px}
        }
    </style>
</head>

<body>
    <header>
        <div>
            <h1>üîê Clasificador de Ransomware</h1>
            <p class="small">Sube un EXE o completa los campos manuales para evaluar si un archivo parece ransomware.</p>
        </div>
        <div style="margin-left:auto;text-align:right">
            <div class="small">Estado del modelo:<br><span id="apiBadge" class="badge">Revisar archivo / modelo</span></div>
            <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
                <input type="text" id="apiInput" placeholder="http://localhost:5000" style="width:220px">
                <button id="saveApiBtn" class="secondary" onclick="saveApiUrl()">Guardar</button>
                <button id="checkApiBtn" class="secondary" onclick="checkApiHealth()">Comprobar</button>
            </div>
        </div> 
    </header>

    <div class="container">

      <aside class="sidebar-left card" aria-hidden="true">
        <div class="hero">
          <h2 style="margin:0 0 6px;font-size:18px">AI ‚Ä¢ Machine Learning ‚Ä¢ Detecci√≥n</h2>
          <p class="small" style="margin:0 0 12px">Modelos y visualizaciones para detectar patrones en ejecutables.</p>

          <div class="hero-images" role="presentation">
            <figure>
              <div class="hero-placeholder">IA</div>
              <figcaption>IA & modelos</figcaption>
            </figure>
            <figure>
              <div class="hero-placeholder">ML</div>
              <figcaption>Modelos</figcaption>
            </figure>
            <figure>
              <div class="hero-placeholder">Data</div>
              <figcaption>Features</figcaption>
            </figure>
          </div>
        </div>
      </aside>

      <main class="main">
        <div class="card" aria-live="polite">
            <h2>üìÅ Subir archivo EXE</h2>
            <label for="fileInput">Seleccionar archivo</label>
            <input type="file" id="fileInput" accept=".exe" aria-describedby="fileHelp" />
            <div id="fileHelp" class="small muted">Solo .exe. M√°x. 10MB.</div>
            <div class="controls">
                <button id="uploadBtn" onclick="uploadFile()">Analizar archivo</button>
                <button class="secondary" onclick="clearResult()">Limpiar resultado</button>
                <button class="secondary" id="downloadResultBtn" data-admin="true" onclick="downloadResult()">Descargar resultado</button>
            </div>
            <!-- Resultado r√°pido junto al upload -->
            <div style="margin-top:12px">
                <label for="quickResult">Resultado (r√°pido)</label>
                <pre id="quickResult" class="small" style="background:#f3f4f6;color:#111;padding:10px;border-radius:8px">Aqu√≠ aparecer√° el resultado r√°pido...</pre>
            </div>
        </div>

        <div class="card">
            <h2>‚úçÔ∏è Ingresar valores manualmente</h2>



            <div id="manualFields" aria-label="Campos manuales"></div>
            <div class="controls">
                <button id="manualBtn" onclick="predictManual()">Clasificar Manual</button>
                <button class="secondary" onclick="clearManual()">Limpiar campos</button>
            </div>
        </div>

        <div class="card" id="dashboardCard">
            <h2>üìä Dashboard</h2>
            <div id="dashboardStats" class="small">
                <div>Cantidad de Visitas: Para revsiar el modelo de Machine learning <strong id="statVisits">0</strong></div>
                <div>Cantidad Archivos valdiadro con IA: <strong id="statFiles">0</strong></div>
                <div>Cantidad Benignos: Archivos Negativos <strong id="statBenign">0</strong></div>
                <div>Cantidad de Ransomware: Archivos Positivos <strong id="statRansom">0</strong></div>
                <div>No aplicable(Archivos que no son .exe, .dll): <strong id="statNA">0</strong></div>
            </div>
            <div class="controls">
                <button onclick="fetchStats()">Actualizar</button>
                <button class="secondary" onclick="downloadStats()">Exportar JSON</button>
            </div>
        </div>

        <div class="card">
            <h2>Resultado del analisis de IA</h2>
            <pre id="result">Aqu√≠ aparecer√° la respuesta IA...</pre>
        </div>
      </main>

      <aside class="sidebar-right card" aria-label="Comentarios del agente">
        <h2>üìù Deja tu Comentarios del Modelo de IA</h2>
        <textarea id="commentInput" rows="5" placeholder="Escribe observaciones sobre la prueba..."></textarea>
        <div class="controls">
            <button id="saveCommentBtn" onclick="saveComment()">Enviar  comentario</button>
            <button class="secondary" data-admin="true" onclick="clearComments()">Limpiar historial o nuevo</button>
        </div>

        <div style="display:flex;gap:8px;margin-top:8px">
            <button class="secondary" onclick="exportComments()">Exportar JSON</button>
            <button class="secondary" onclick="exportCommentsCSV()">Exportar CSV</button>
        </div>

        <h3 style="margin-top:12px">Historial</h3>
        <ul id="commentsList" class="small"></ul>
      </aside>

    </div>

    <script>
        // API URL: por defecto usa el mismo origen (√∫til en despliegues). El usuario puede sobrescribirlo en el campo "API actual".
        const DEFAULT_API = window.location.origin;
        let API_URL = localStorage.getItem('api_url') || DEFAULT_API;

        const fields = [
            "Machine", "DebugSize", "DebugRVA", "MajorImageVersion", "MajorOSVersion",
            "ExportRVA", "ExportSize", "IatVRA", "MajorLinkerVersion", "MinorLinkerVersion",
            "NumberOfSections", "SizeOfStackReserve", "DllCharacteristics", "ResourceSize",
            "BitcoinAddresses"
        ];

        // Ejemplos r√°pidos


        // Estado de √∫ltimo resultado para descargar
        let lastResult = null;

        function updateApiBadge() {
            const badge = document.getElementById('apiBadge');
            document.getElementById('apiInput').value = API_URL === DEFAULT_API ? '' : API_URL;
            badge.textContent = API_URL;
            badge.classList.remove('online','offline');
            // Lanzar una comprobaci√≥n de salud en segundo plano (sin alertas)
            checkApiHealth(false);
        }

        function saveApiUrl() {
            const v = document.getElementById('apiInput').value.trim();
            if (v === '') { localStorage.removeItem('api_url'); API_URL = DEFAULT_API; }
            else { API_URL = v; localStorage.setItem('api_url', v); }
            updateApiBadge();
            alert('API guardada: ' + API_URL);
        }

        function renderManualFields() {
            let html = "";
            fields.forEach(f => {
                html += `<label for="${f}">${f}</label>`;
                html += `<input type="number" id="${f}" placeholder="Ej: 0" aria-label="${f}">`;
            });
            document.getElementById("manualFields").innerHTML = html;


        }

        function setLoading(el, isLoading) {
            if (isLoading) {
                el.dataset.oldText = el.innerHTML;
                el.innerHTML = `<span class="spinner"></span> Procesando...`;
                el.disabled = true;
            } else {
                el.innerHTML = el.dataset.oldText || el.innerHTML;
                el.disabled = false;
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            const btn = document.getElementById('uploadBtn');
            if (!fileInput.files.length) return updateResult("Selecciona un archivo", true);

            const file = fileInput.files[0];
            if (!/\.exe$/i.test(file.name)) return updateResult("Solo se permiten archivos .exe", true);
            if (file.size > 10 * 1024 * 1024) return updateResult("Archivo demasiado grande (>10MB)", true);

            setLoading(btn, true);
            updateResult("Analizando archivo...");

            try {
                const formData = new FormData();
                formData.append("file", file);

                const res = await fetch(`${API_URL}/predict`, { method: "POST", body: formData });
                if (!res.ok) {
                    const t = await res.text();
                    throw new Error(`Error ${res.status}: ${t}`);
                }

                const data = await res.json();
                lastResult = data;
                const formatted = JSON.stringify(data, null, 2);
                updateResult(formatted);
                setQuickResult(formatted);

            } catch (err) {
                const m = err && err.message ? err.message : '';
                if (m.includes('Failed to fetch') || err.name === 'AbortError') {
                    updateResult(`Error: No se pudo conectar con la API en ${API_URL}. Revisa la URL o el estado del servidor.`, true);
                    checkApiHealth(false);
                } else {
                    updateResult(`Error: ${err.message}`, true);
                }
            } finally {
                setLoading(btn, false);
            }
        }

        async function predictManual() {
            const btn = document.getElementById('manualBtn');
            const payload = {};

            try {
                fields.forEach(f => {
                    const el = document.getElementById(f);
                    if (!el) throw new Error(`Campo ${f} no encontrado`);
                    const v = el.value;
                    if (v === "") throw new Error(`El campo ${f} est√° vac√≠o`);
                    const n = Number(v);
                    if (!isFinite(n)) throw new Error(`Valor inv√°lido en ${f}`);
                    payload[f] = n;
                });
            } catch (err) {
                return updateResult(`Validaci√≥n: ${err.message}`, true);
            }

            setLoading(btn, true);
            updateResult("Clasificando...");

            try {
                const res = await fetch(`${API_URL}/predict_manual`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    const t = await res.text();
                    throw new Error(`Error ${res.status}: ${t}`);
                }
                const data = await res.json();
                lastResult = data;
                const formatted = JSON.stringify(data, null, 2);
                updateResult(formatted);
                setQuickResult(formatted);

            } catch (err) {
                const m = err && err.message ? err.message : '';
                if (m.includes('Failed to fetch') || err.name === 'AbortError') {
                    updateResult(`Error: No se pudo conectar con la API en ${API_URL}. Revisa la URL o el estado del servidor.`, true);
                    checkApiHealth(false);
                } else {
                    updateResult(`Error: ${err.message}`, true);
                }
            } finally {
                setLoading(btn, false);
            }
        }

        function updateResult(text, isError = false) {
            const r = document.getElementById('result');
            r.textContent = text;
            r.style.color = isError ? '#ff6666' : '#e6eef8';
        }

        function clearManual(){
            fields.forEach(f => document.getElementById(f).value = '');
        }

        function setQuickResult(text){
            const el = document.getElementById('quickResult');
            if (el) el.textContent = text;
        }

        // Comprobaci√≥n de salud de la API
        async function checkApiHealth(showAlert = true) {
            const badge = document.getElementById('apiBadge');
            badge.textContent = 'Comprobando...';
            badge.classList.remove('online','offline');
            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 5000);
                const res = await fetch(`${API_URL}/api`, { signal: controller.signal });
                clearTimeout(id);
                if (res.ok) {
                    badge.textContent = API_URL;
                    badge.classList.add('online');
                    return true;
                } else {
                    badge.textContent = 'Revisar archivo / modelo';
                    badge.classList.add('offline');
                    if (showAlert) alert(`API responded ${res.status}: ${await res.text().catch(()=>res.statusText)}`);
                    return false; 
                }
            } catch (err) {
                badge.textContent = 'Revisar archivo / modelo';
                badge.classList.add('offline');
                if (showAlert) alert(`No se puede conectar a la API en ${API_URL}: ${err.message}`);
                return false;
            }
        }

        function clearResult(){
            document.getElementById('result').textContent = 'Aqu√≠ aparecer√° la respuesta...';
            const qr = document.getElementById('quickResult'); if (qr) qr.textContent = 'Aqu√≠ aparecer√° el resultado r√°pido...';
            lastResult = null;
        }



        // Comentarios
        async function renderComments() {
            try {
                const res = await fetch(`${API_URL}/comments`);
                if (!res.ok) throw new Error(await res.text());
                const list = await res.json();
                const ul = document.getElementById('commentsList');
                ul.innerHTML = '';
                list.forEach(c => {
                    const li = document.createElement('li');
                    const ts = new Date(c.ts).toLocaleString();
                    li.textContent = `${ts} ‚Äî ${c.text} ${c.email_sent ? '(email enviado)' : ''}`;
                    ul.appendChild(li);
                });
            } catch (err) {
                console.error('Error fetching comments:', err);
                const msg = err && err.message ? err.message : '';
                if (msg.includes('Failed to fetch') || msg.includes('NetworkError') || err.name === 'AbortError') {
                    checkApiHealth(false);
                }
            }
        }

        async function saveComment() {
            const txt = document.getElementById('commentInput').value.trim();
            if (!txt) return alert('Escribe un comentario antes de guardar');
            const btn = document.getElementById('saveCommentBtn');
            setLoading(btn, true);
            try {
                const res = await fetch(`${API_URL}/comment`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ text: txt }) });
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                document.getElementById('commentInput').value = '';
                renderComments();
                alert('Comentario guardado' + (data.email_sent ? ' y enviado por correo.' : ' (no se envi√≥ por falta de configuraci√≥n SMTP)'));
            } catch (err) {
                const msg = err && err.message ? err.message : '';
                if (msg.includes('Failed to fetch') || msg.includes('NetworkError') || err.name === 'AbortError') {
                    alert('No se pudo conectar con la API en ' + API_URL + '. Revisa la URL arriba ("API actual") o comprueba que el servidor est√© funcionando.');
                    checkApiHealth(false);
                } else {
                    alert('Error: ' + err.message);
                }
            } finally {
                setLoading(btn, false);
            }
        }

        async function clearComments(){
            if (!confirm('Borrar todo el historial de comentarios?')) return;
            try {
                const res = await fetch(`${API_URL}/comments/clear`, { method: 'POST' });
                if (!res.ok) throw new Error(await res.text());
                renderComments();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function exportComments(){
            try {
                const res = await fetch(`${API_URL}/comments`);
                if (!res.ok) throw new Error(await res.text());
                const list = await res.json();
                const blob = new Blob([JSON.stringify(list, null, 2)], {type:'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='comments.json'; a.click();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function exportCommentsCSV(){
            try {
                const res = await fetch(`${API_URL}/comments`);
                if (!res.ok) throw new Error(await res.text());
                const list = await res.json();
                const lines = [['timestamp','text']];
                list.forEach(c => lines.push([c.ts, '"'+c.text.replace(/"/g,'""')+'"']));
                const blob = new Blob([lines.map(l=>l.join(',')).join('\n')], {type:'text/csv'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='comments.csv'; a.click();
            } catch (err) { alert('Error: ' + err.message); }
        }

        function downloadResult(){
            if (!lastResult) return alert('No hay resultado para descargar');
            const blob = new Blob([JSON.stringify(lastResult, null, 2)], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='result.json'; a.click();
        }

        async function fetchStats(){
            try {
                const res = await fetch(`${API_URL}/stats`);
                if (!res.ok) throw new Error(await res.text());
                const s = await res.json();
                document.getElementById('statVisits').textContent = s.visits;
                document.getElementById('statFiles').textContent = s.files_tested;
                document.getElementById('statBenign').textContent = s.benign;
                document.getElementById('statRansom').textContent = s.ransomware;
                document.getElementById('statNA').textContent = s.not_applicable;
            } catch (err) { console.error('Error fetching stats:', err); const msg = err && err.message ? err.message : ''; if (msg.includes('Failed to fetch') || msg.includes('NetworkError') || err.name === 'AbortError') { checkApiHealth(false); } }
        }

        function downloadStats(){
            fetch(`${API_URL}/stats`).then(r=>r.json()).then(data=>{
                const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='stats.json'; a.click();
            }).catch(err=>alert('Error: '+err.message));
        }

        window.onload = () => {
            updateApiBadge();
            renderManualFields();
            // notify server of a visit (non-blocking)
            fetch(`${API_URL}/visit`, { method: 'POST' }).catch(()=>{});
            renderComments();
            fetchStats();

            // ocultar botones de administraci√≥n por defecto; a√±adir '?admin=1' a la URL para activarlos (guardado en localStorage)
            if (!isAdmin()) {
                document.querySelectorAll('[data-admin="true"]').forEach(el => el.style.display = 'none');
            } else {
                console.log('Admin mode enabled ‚Äî botones de administraci√≥n visibles');
            }
        };
    </script>

    <!-- Footer profesional -->
    <footer style="margin-top:28px;padding:20px 24px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.6));box-shadow:0 6px 18px rgba(14,30,80,0.04);display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <div style="display:flex;flex-direction:column;gap:6px">
            <strong style="color:var(--primary);font-size:15px">Clasificador de Ransomware</strong>
            <span class="small muted">Proyecto de detecci√≥n de ransomware en ejecutables ‚Äî uso responsable y fines educativos.</span>
        </div>
        <div style="display:flex;gap:12px;align-items:center">
            <a href="https://github.com/tu-usuario/tu-repo" target="_blank" rel="noopener noreferrer" style="text-decoration:none;color:var(--primary);font-weight:600">Ver en GitHub</a>
            <a href="mailto:contacto@example.com" style="text-decoration:none;color:var(--muted)">contacto@example.com</a>
            <span class="small muted">¬© 2025</span>
        </div>
    </footer>

</body>

</html>