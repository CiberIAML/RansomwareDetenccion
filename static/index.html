<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clasificador Ransomware</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 750px;
            margin: 40px auto;
            background-color: #f7f7f7;
            color: #333;
        }

        .card {
            padding: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            margin-bottom: 25px;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        h1 {
            color: #007bff;
            text-align: center;
        }
        
        h2 {
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            color: #555;
        }

        input[type="number"],
        input[type="file"],
        button {
            padding: 12px;
            width: 100%;
            margin-top: 10px;
            border-radius: 8px;
            box-sizing: border-box;
        }
        
        input[type="number"],
        input[type="file"] {
            border: 1px solid #ccc;
        }

        button {
            background: #007bff;
            border: none;
            color: white;
            cursor: pointer;
            transition: background 0.3s, transform 0.1s;
        }

        button:hover:not(:disabled) {
            background: #0056b3;
        }
        
        button:disabled {
            background: #a0c3ff;
            cursor: not-allowed;
        }

        pre {
            background: #f3f3f3;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.9em;
            overflow-x: auto;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: #444;
        }
        
        #messageBox {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: none; /* Oculto por defecto */
            font-weight: bold;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .ransomware {
             background-color: #ffe0b2; /* Naranja Suave */
             color: #ff5722; /* Naranja Oscuro */
             border: 1px solid #ff9800;
        }
        
        .loading {
             animation: pulse 1s infinite alternate;
        }
        
        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }
    </style>
</head>

<body>
    <h1>üîê Clasificador de Ransomware</h1>
    <p style="text-align: center; color: #666;">Sube un archivo PE (EXE/DLL) o ingresa los valores de las caracter√≠sticas manualmente.</p>

    <div id="messageBox"></div>

    <div class="card">
        <h2>üìÅ Subir archivo PE</h2>
        <input type="file" id="fileInput" accept=".exe,.dll" required>
        <button onclick="uploadFile()" id="uploadButton">Clasificar Archivo</button>
    </div>

    <div class="card">
        <h2>üî¢ Entrada Manual de Caracter√≠sticas</h2>
        <form id="manualInputForm">
            <div id="manualFields">
                <!-- Los campos de entrada se generar√°n aqu√≠ por JavaScript -->
            </div>
            <button type="button" onclick="predictManual()" id="manualButton">Clasificar Manualmente</button>
        </form>
    </div>

    <div class="card">
        <h2>Resultado de la Clasificaci√≥n (JSON)</h2>
        <pre id="result">Esperando datos...</pre>
    </div>

    <script>
        // Configuraci√≥n de la API. Asume que la API est√° en la misma URL base.
        const API_URL = ""; 

        // Lista de caracter√≠sticas (debe coincidir con el backend)
        const fields = [
            "Machine",
            "DebugSize",
            "DebugRVA",
            "MajorImageVersion",
            "MajorOSVersion",
            "ExportRVA",
            "ExportSize",
            "IatVRA",
            "MajorLinkerVersion",
            "MinorLinkerVersion",
            "NumberOfSections",
            "SizeOfStackReserve",
            "DllCharacteristics",
            "ResourceSize",
            "BitcoinAddresses"
        ];

        // Funci√≥n para mostrar mensajes y errores
        function showMessage(message, type = 'error') {
            const msgBox = document.getElementById("messageBox");
            msgBox.textContent = message;
            msgBox.className = ''; // Limpia clases anteriores
            msgBox.classList.add(type);
            msgBox.style.display = 'block';
            
            // Ocultar despu√©s de 5 segundos si no es error cr√≠tico (como un error de red)
            if (type === 'success' || type === 'ransomware') {
                setTimeout(() => msgBox.style.display = 'none', 5000);
            }
        }
        
        // Funci√≥n para limpiar el mensaje
        function clearMessage() {
            document.getElementById("messageBox").style.display = 'none';
        }

        // Generar campos de entrada manualmente al cargar la p√°gina
        window.onload = () => {
            let html = "";
            fields.forEach(f => {
                // Se inicializan en 0 para evitar errores de validaci√≥n de FastAPI
                html += `<label for="${f}">${f}</label>
                 <input type="number" id="${f}" name="${f}" placeholder="Ingresa valor para ${f}" value="0">`; 
            });
            document.getElementById("manualFields").innerHTML = html;
        };
        
        // Funci√≥n auxiliar para obtener el mensaje de error de la respuesta
        async function getErrorMessage(res) {
             try {
                const errorData = await res.json();
                
                // Manejar errores de validaci√≥n de Pydantic/FastAPI
                if (errorData.detail && Array.isArray(errorData.detail)) {
                    const validationErrors = errorData.detail.map(d => 
                        `[${d.loc.join('.')}] - ${d.msg}`
                    ).join('; ');
                    return `Error de Validaci√≥n (${res.status}): ${validationErrors}`;
                }
                
                // Manejar errores definidos en el backend (ej: {"error": "..."})
                if (errorData.error) {
                    return `Error del Servidor: ${errorData.error}`;
                }
                
                // Fallback para otros JSON
                return `Error HTTP ${res.status}: ${JSON.stringify(errorData)}`;
            } catch {
                // Si la respuesta no es JSON (ej: error 500 HTML)
                return `Error HTTP ${res.status}: ${res.statusText}. El servidor no devolvi√≥ una respuesta JSON v√°lida.`;
            }
        }

        // Funci√≥n para subir y clasificar archivo
        async function uploadFile() {
            clearMessage();
            document.getElementById("result").textContent = "Enviando archivo...";
            const fileInput = document.getElementById("fileInput");
            const button = document.getElementById("uploadButton");
            
            if (!fileInput.files.length) {
                return showMessage("‚ùå ERROR: Debes seleccionar un archivo para clasificar.", 'error');
            }
            
            button.disabled = true;
            button.textContent = "Clasificando... ‚è≥";
            button.classList.add('loading');

            try {
                const formData = new FormData();
                formData.append("file", fileInput.files[0]);

                const res = await fetch(`${API_URL}/predict`, {
                    method: "POST",
                    body: formData
                });
                
                // Verificar si la respuesta fue exitosa (status 200-299)
                if (!res.ok) {
                    const errorMessage = await getErrorMessage(res);
                    showMessage(`‚ùå Error en la predicci√≥n del archivo: ${errorMessage}`, 'error');
                    return;
                }

                // Procesar respuesta exitosa
                const data = await res.json();
                
                // Mostrar la predicci√≥n en el cuadro de resultados
                document.getElementById("result").textContent = JSON.stringify(data, null, 2);
                
                const label = data.prediction || "N/A";
                const color = label === "benign" ? 'success' : 'ransomware';
                showMessage(`‚úÖ Predicci√≥n Exitosa. Resultado: ${label.toUpperCase()}`, color);

            } catch (e) {
                // Error de red (fetch fail)
                showMessage(`‚ùå Error de Conexi√≥n: No se pudo contactar con el servidor. (${e.message})`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = "Clasificar Archivo";
                button.classList.remove('loading');
            }
        }

        // Funci√≥n para clasificar manualmente
        async function predictManual() {
            clearMessage();
            document.getElementById("result").textContent = "Enviando datos...";
            const button = document.getElementById("manualButton");
            const payload = {};
            let hasEmptyField = false;
            let hasNaN = false;

            // Recoger y validar datos
            fields.forEach(f => {
                const inputElement = document.getElementById(f);
                // Si el campo est√° vac√≠o o no es un n√∫mero v√°lido despu√©s de la conversi√≥n
                if (inputElement.value === "" || inputElement.value === null) {
                    hasEmptyField = true;
                }
                const numValue = Number(inputElement.value);
                if (isNaN(numValue)) {
                    hasNaN = true;
                }
                payload[f] = numValue;
            });
            
            if (hasEmptyField || hasNaN) {
                 return showMessage("‚ùå ERROR: Por favor, rellena todos los campos con valores num√©ricos v√°lidos.", 'error');
            }
            
            button.disabled = true;
            button.textContent = "Clasificando... ‚è≥";
            button.classList.add('loading');

            try {
                const res = await fetch(`${API_URL}/predict_manual`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                
                // Verificar si la respuesta fue exitosa (status 200-299)
                if (!res.ok) {
                    const errorMessage = await getErrorMessage(res);
                    showMessage(`‚ùå Error en la predicci√≥n manual: ${errorMessage}`, 'error');
                    return;
                }

                // Procesar respuesta exitosa
                const data = await res.json();
                
                // Mostrar la predicci√≥n en el cuadro de resultados
                document.getElementById("result").textContent = JSON.stringify(data, null, 2);
                
                const label = data.prediction || "N/A";
                const color = label === "benign" ? 'success' : 'ransomware';
                showMessage(`‚úÖ Predicci√≥n Exitosa. Resultado: ${label.toUpperCase()}`, color);

            } catch (e) {
                // Error de red (fetch fail)
                showMessage(`‚ùå Error de Conexi√≥n: No se pudo contactar con el servidor. (${e.message})`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = "Clasificar Manualmente";
                button.classList.remove('loading');
            }
        }
    </script>

    <footer>
        <p style="text-align: center; margin-top: 30px; font-size: 0.8em; color: #999;">&copy; 2025 Detecci√≥n de Ransomware en Archivos Ejecutables de Windows PE. Modelo de Machine Learning para fines acad√©micos y de prueba. Desarrollado por Equipo TALENTO TECH.</p>
    </footer>

</body>

</html>
