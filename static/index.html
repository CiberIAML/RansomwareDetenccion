<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clasificador Ransomware</title>
    <style>
        /* Estilos Globales */
        body {
            font-family: 'Inter', Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 900px;
            width: 100%;
        }

        h1 {
            color: #1a73e8;
            text-align: center;
            margin-bottom: 20px;
        }

        .card {
            background-color: #ffffff;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        /* Estilos de Controles */
        input,
        button,
        select {
            padding: 12px;
            width: 100%;
            margin-top: 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
            box-sizing: border-box; /* Asegura que el padding no afecte el ancho total */
            font-size: 16px;
        }

        .primary-button {
            background: #1a73e8;
            border: none;
            color: white;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.3s ease;
        }

        .primary-button:hover {
            background: #155bb5;
        }
        
        .clear-button {
            background: #dc3545;
            border: none;
            color: white;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s ease;
        }

        .clear-button:hover {
            background: #c82333;
        }

        /* Controles de Subida de Archivos */
        #fileUploadControls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #fileInput {
            flex-grow: 1;
        }

        #fileUploadControls button {
            width: auto;
            min-width: 150px;
            margin-top: 0;
        }

        /* √Årea de Resultados */
        h2 {
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }

        pre {
            background: #f3f3f3;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Mensajes (Reemplazo de alert()) */
        .message-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none; /* Oculto por defecto */
            font-weight: bold;
            text-align: center;
        }

        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            #fileUploadControls {
                flex-direction: column;
            }
            #fileUploadControls button {
                width: 100%;
                min-width: unset;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîê Clasificador de Ransomware PE</h1>
        <p>Sube un archivo ejecutable (.exe, .dll) o ingresa los valores manualmente para su clasificaci√≥n.</p>
        
        <!-- √Årea de mensajes -->
        <div id="messageBox" class="message-box"></div>

        <div class="card">
            <h2>üìÅ Subir archivo EXE</h2>
            <div id="fileUploadControls">
                <input type="file" id="fileInput" accept=".exe, .dll">
                <button onclick="uploadFile()" class="primary-button">Analizar Archivo</button>
            </div>
            <button onclick="clearAllResults()" class="clear-button">Limpiar Resultados y Nuevo Archivo</button>
        </div>

        <div class="card">
            <h2>‚öôÔ∏è Ingreso Manual de Caracter√≠sticas</h2>
            <div id="manualFields">
                <!-- Los campos de entrada se generar√°n aqu√≠ por JavaScript -->
            </div>
            <button onclick="predictManual()" class="primary-button">Predecir Manualmente</button>
        </div>

        <div class="card">
            <h2>Resultado de Predicci√≥n</h2>
            <pre id="result">Aqu√≠ aparecer√° el resultado de la predicci√≥n (JSON).</pre>
        </div>
    </div>

    <script>
        // La URL de la API de FastAPI es relativa al host
        const API_URL = ""; 

        // Columnas de caracter√≠sticas esperadas por el backend
        const fields = [
            "Machine", "DebugSize", "DebugRVA", "MajorImageVersion", "MajorOSVersion",
            "ExportRVA", "ExportSize", "IatVRA", "MajorLinkerVersion", "MinorLinkerVersion",
            "NumberOfSections", "SizeOfStackReserve", "DllCharacteristics", "ResourceSize", "BitcoinAddresses"
        ];

        // Funci√≥n para mostrar mensajes personalizados (reemplaza alert())
        function showMessage(message, isError = false) {
            const msgBox = document.getElementById('messageBox');
            msgBox.textContent = message;
            msgBox.className = isError ? 'message-box error' : 'message-box success';
            msgBox.style.display = 'block';
            // Ocultar despu√©s de 5 segundos
            setTimeout(() => {
                msgBox.style.display = 'none';
                msgBox.className = 'message-box';
            }, 5000);
        }

        // Funci√≥n para limpiar todos los campos y resultados
        function clearAllResults() {
            // 1. Limpiar input de archivo
            document.getElementById("fileInput").value = null;

            // 2. Limpiar campos de entrada manual
            fields.forEach(f => {
                const input = document.getElementById(f);
                if (input) input.value = '';
            });

            // 3. Limpiar el resultado mostrado
            document.getElementById("result").textContent = "Aqu√≠ aparecer√° el resultado de la predicci√≥n (JSON).";
            
            // 4. Mostrar confirmaci√≥n de limpieza
            showMessage("‚úÖ Resultados y campos de entrada limpiados.", false);
        }

        window.onload = () => {
            // Generar din√°micamente los campos para la entrada manual
            let html = "";
            fields.forEach(f => {
                html += `<label for="${f}">${f}</label>
                 <input type="number" id="${f}" placeholder="Ingresa valor para ${f}" value="" required>`;
            });
            document.getElementById("manualFields").innerHTML = html;
        };

        // Funci√≥n para subir y predecir archivo
        async function uploadFile() {
            const fileInput = document.getElementById("fileInput");
            if (!fileInput.files.length) {
                return showMessage("üõë Selecciona un archivo para analizar.", true);
            }

            // Muestra estado de carga
            document.getElementById("result").textContent = "Analizando archivo... por favor espera.";

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            try {
                const res = await fetch(`${API_URL}/predict`, {
                    method: "POST",
                    body: formData
                });

                const data = await res.json();
                
                if (data.error) {
                    document.getElementById("result").textContent = JSON.stringify(data, null, 2);
                    showMessage(`üî¥ Error en el an√°lisis: ${data.error}`, true);
                } else {
                    document.getElementById("result").textContent = JSON.stringify(data, null, 2);
                    showMessage(`‚úÖ Predicci√≥n completa: Resultado: ${data.prediction}`, false);
                }

            } catch (e) {
                document.getElementById("result").textContent = `Error de conexi√≥n: ${e.message}`;
                showMessage("‚ùå Error de conexi√≥n con la API. Aseg√∫rate de que el backend est√© funcionando.", true);
            }
        }

        // Funci√≥n para predecir con entrada manual
        async function predictManual() {
            const payload = {};
            let isValid = true;
            
            // Recolectar datos y validar
            fields.forEach(f => {
                const input = document.getElementById(f);
                const value = Number(input.value);
                if (isNaN(value) || input.value.trim() === "") {
                    isValid = false;
                    return;
                }
                payload[f] = value;
            });

            if (!isValid) {
                return showMessage("üõë Por favor, rellena todos los campos de entrada manual con n√∫meros v√°lidos.", true);
            }
            
            // Muestra estado de carga
            document.getElementById("result").textContent = "Realizando predicci√≥n manual... por favor espera.";

            try {
                const res = await fetch(`${API_URL}/predict_manual`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                
                if (data.error) {
                    document.getElementById("result").textContent = JSON.stringify(data, null, 2);
                    showMessage(`üî¥ Error en la predicci√≥n: ${data.error}`, true);
                } else {
                    document.getElementById("result").textContent = JSON.stringify(data, null, 2);
                    showMessage(`‚úÖ Predicci√≥n completa: Resultado: ${data.prediction}`, false);
                }

            } catch (e) {
                document.getElementById("result").textContent = `Error de conexi√≥n: ${e.message}`;
                showMessage("‚ùå Error de conexi√≥n con la API. Aseg√∫rate de que el backend est√© funcionando.", true);
            }
        }
    </script>
</body>

</html>
