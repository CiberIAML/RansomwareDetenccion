<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Clasificador Ransomware</title>
    
    <style>
        /* Definici√≥n de variables de colores (Temas) */
        :root{--bg:#f4f8ff;--text:#0f1724;--muted:#64748b;--primary:#1e6fff;--card:#ffffff}
        
        /* Estilos globales del cuerpo de la p√°gina */
        html,body{height:100%}
        body {
            font-family: Inter, Arial, sans-serif;
            margin: 0; padding: 24px 36px;
            color:var(--text);
            background: linear-gradient(180deg, #f7fbff 0%, #f4f8ff 100%);
        }

        /* Dise√±o del encabezado con sombra y gradiente */
        header{display:flex;flex-direction:row;align-items:center;gap:6px;margin-bottom:20px;background:linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.8));padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(30,79,255,0.06)}
        header h1{font-size:22px;margin:0;color:var(--primary)}
        
        /* Contenedor principal dividido en 3 columnas (Sidebar Izquierda, Centro, Sidebar Derecha) */
        .container { display: flex; gap: 18px; align-items: flex-start; }
        .sidebar-left, .sidebar-right { width: 26%; min-width: 220px; }
        .main { width: 48%; min-width: 420px; }

        /* Estilo para las tarjetas blancas que contienen los m√≥dulos */
        .card {
            padding: 16px; border: 1px solid #e6e9ef; border-radius: 10px;
            margin-bottom: 14px; background: #fff;
            box-shadow: 0 1px 4px rgba(20,33,61,0.04);
        }

        /* Estilos para formularios: botones, inputs y selectores */
        input, button, textarea {
            padding: 10px; width: 100%; margin-top: 8px; box-sizing: border-box;
            font-size: 14px; border: 1px solid #d1d5db; border-radius: 8px;
        }

        button {
            background: var(--primary); color: white; cursor: pointer;
            font-weight:600; border: none; transition: 0.2s;
        }
        button:hover { background: #165ed9; }
        button.secondary{background:#f3f4f6; color:#111; border:1px solid #e5e7eb}

        /* Consola de detalles (fondo oscuro estilo c√≥digo) */
        pre {
            background: #0f1724; color: #e6eef8; padding: 14px; border-radius:8px;
            font-size:13px; max-height:320px; overflow:auto; white-space: pre-wrap;
        }

        /* Animaci√≥n de carga (spinner) cuando la IA est√° analizando */
        .spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin .8s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* Estilos visuales para los resultados: Verde (Benigno) o Naranja (Ransomware) */
        .visual-result{display:flex;align-items:center;gap:12px;margin-top:12px;padding:12px;border-radius:10px;background:#fff;}
        .visual-result.benign{border-left:4px solid #16a34a;}
        .visual-result.ransomware{border-left:4px solid #f97316;}

        /* Responsividad: si la pantalla es peque√±a, las columnas se apilan una debajo de otra */
        @media (max-width: 900px) { .container{flex-direction:column} .sidebar-left,.sidebar-right,.main{width:100%} }
    </style>
</head>

<body>
    <header>
        <div>
            <h1>üîê Clasificador de Ransomware IA</h1>
            <p>Sube un EXE o completa los campos manuales.</p>
        </div>
        <div style="margin-left:auto;text-align:right">
            <div class="small" style="font-size: 11px; color: var(--muted)">Estado API:<br><span id="apiBadge" class="badge">Listo</span></div>
            <div style="margin-top:8px;display:flex;gap:8px">
                <input type="text" id="apiInput" placeholder="URL de la API" style="width:180px; padding:6px">
                <button id="saveApiBtn" class="secondary" onclick="saveApiUrl()" style="width:auto">OK</button>
                <button id="openAdminBtn" class="secondary" onclick="openAdminModal()" style="width:auto">Admin</button>
            </div> 
        </div> 
    </header>

    <div id="adminModal" style="display:none;position:fixed;top:20%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border-radius:8px;z-index:1000;box-shadow:0 10px 30px rgba(0,0,0,0.1)">
        <h3>Acceso administrador</h3>
        <input id="adminTokenInput" type="password" placeholder="Token admin">
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
            <button class="secondary" onclick="closeAdminModal()">Cancelar</button>
            <button onclick="adminLogin()">Validar</button>
        </div>
    </div>
    <div id="adminBackdrop" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.25);z-index:900" onclick="closeAdminModal()"></div>

    <div class="container">
      <aside class="sidebar-left">
        <div class="card">
            <h2>üìä Estad√≠sticas</h2>
            <div id="dashboardStats">
                <div>Visitas: <strong id="statVisits">0</strong></div>
                <div>Archivos: <strong id="statFiles">0</strong></div>
                <div>Benignos: <strong id="statBenign">0</strong></div>
                <div>Ransomware: <strong id="statRansom">0</strong></div>
            </div>
            <button onclick="fetchStats()">Actualizar</button>
        </div>
      </aside>

      <main class="main">
        <div class="card">
            <h2>üìÅ Analizar Archivo</h2>
            <label>Seleccionar ejecutable (.exe)</label>
            <input type="file" id="fileInput" accept=".exe" />
            <div class="controls">
                <button id="uploadBtn" onclick="uploadFile()">Ejecutar An√°lisis IA</button>
                <button class="secondary" onclick="clearResult()">Limpiar</button>
            </div>
            <div id="visualResult" class="visual-result" style="display:none">
                <div class="emoji" id="visualEmoji">üéØ</div>
                <div>
                    <div id="visualMsg">Resultado</div>
                    <div id="visualSub" style="font-size:12px; color:var(--muted)">---</div>
                </div>
            </div> 
        </div>

        <div class="card">
            <h2>‚úçÔ∏è Entrada Manual</h2>
            <div id="manualFields" style="max-height: 250px; overflow-y: auto;"></div>
            <button id="manualBtn" onclick="predictManual()">Clasificar Manualmente</button>
        </div>

        <div class="card">
            <h2>üîç Detalles del Modelo</h2>
            <pre id="result">Esperando an√°lisis...</pre>
        </div>
      </main>

      <aside class="sidebar-right">
        <div class="card">
            <h2>üìù Comentarios</h2>
            <textarea id="commentInput" rows="4" placeholder="Escribe aqu√≠..."></textarea>
            <button onclick="saveComment()">Enviar</button>
            <h3>Historial</h3>
            <ul id="commentsList" style="list-style:none; padding:0"></ul>
        </div>
      </aside>
    </div>

    

    <script>
        // URL base para las peticiones. Se guarda en el navegador (localStorage)
        let API_URL = localStorage.getItem('api_url') || window.location.origin;

        // Lista de columnas t√©cnicas que espera el modelo de IA
        const fields = ["Machine", "DebugSize", "DebugRVA", "MajorImageVersion", "MajorOSVersion", "ExportRVA", "ExportSize", "IatVRA", "MajorLinkerVersion", "MinorLinkerVersion", "NumberOfSections", "SizeOfStackReserve", "DllCharacteristics", "ResourceSize", "BitcoinAddresses"];

        // Al cargar la p√°gina, inicia las funciones b√°sicas
        window.onload = () => {
            renderManualFields();
            updateAdminUI();
            fetch(`${API_URL}/visit`, { method: 'POST' }).catch(()=>{}); // Registrar visita
            fetchStats();
            renderComments();
        };

        // Crea din√°micamente los campos de texto para la entrada manual
        function renderManualFields() {
            let html = "";
            fields.forEach(f => { html += `<label>${f}</label><input type="number" id="${f}" value="0">`; });
            document.getElementById("manualFields").innerHTML = html;
        }

        // Env√≠a el archivo al servidor mediante una petici√≥n POST (Multipart)
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) return alert("Selecciona un archivo .exe");

            const btn = document.getElementById('uploadBtn');
            setLoading(btn, true); // Activa el spinner

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const res = await fetch(`${API_URL.replace(/\/$/, "")}/predict`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                updateResult(JSON.stringify(data, null, 2)); // Muestra el JSON en la consola
                setVisualResult(data.prediction); // Muestra el cartel de Seguro/Amenaza
                fetchStats(); // Actualiza el dashboard
            } catch (err) {
                alert("Error de conexi√≥n con el servidor de IA");
            } finally {
                setLoading(btn, false);
            }
        }

        // Muestra u oculta el estado de carga en los botones
        function setLoading(btn, isLoading) {
            btn.disabled = isLoading;
            if (isLoading) btn.innerHTML = `<span class="spinner"></span> Procesando...`;
            else btn.textContent = btn.id === 'uploadBtn' ? 'Ejecutar An√°lisis IA' : 'Clasificar Manualmente';
        }

        // Actualiza el recuadro visual (Emoji y mensaje) basado en la predicci√≥n
        function setVisualResult(label) {
            const box = document.getElementById('visualResult');
            if (!label) { box.style.display = 'none'; return; }
            box.style.display = 'flex';
            const isRansom = label.toLowerCase().includes('ransomware');
            box.className = `visual-result ${isRansom ? 'ransomware' : 'benign'}`;
            document.getElementById('visualEmoji').textContent = isRansom ? '‚ö†Ô∏è' : '‚úÖ';
            document.getElementById('visualMsg').textContent = isRansom ? 'AMENAZA DETECTADA' : 'ARCHIVO SEGURO';
        }

        // Obtiene las estad√≠sticas de la base de datos (SQLite/Postgres)
        async function fetchStats() {
            try {
                const res = await fetch(`${API_URL.replace(/\/$/, "")}/stats`);
                const s = await res.json();
                document.getElementById('statVisits').textContent = s.visits || 0;
                document.getElementById('statFiles').textContent = s.files_tested || 0;
                document.getElementById('statBenign').textContent = s.benign || 0;
                document.getElementById('statRansom').textContent = s.ransomware || 0;
            } catch (e) {}
        }

        // L√≥gica de administrador para mostrar botones ocultos
        function updateAdminUI() {
            const isAdm = localStorage.getItem('admin_token') !== null;
            document.querySelectorAll('[data-admin="true"]').forEach(el => el.style.display = isAdm ? 'block' : 'none');
        }
    </script>
</body>
</html>